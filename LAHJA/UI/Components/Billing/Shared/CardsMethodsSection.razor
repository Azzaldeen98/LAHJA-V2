@using Domain.ShareData
@using LAHJA.Data.UI.Components
@using LAHJA.Data.UI.Components.Payment.CreditCard
@using LAHJA.Data.UI.Components.Payment.CreditCards
@using LAHJA.Helpers.Services
@using LAHJA.Them   
@using LAHJA.UI.Components.Payment.CreditCard
@using LAHJA.UI.Components.TabelCard
@using MudBlazor
@using System.Globalization
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject LanguageService languageService
@inject IManageLanguageService _manageLanguageService




<MudExpansionPanels>
    @if (creditCards == null || creditCards.Count == 0)
    {
        <MudExpansionPanel @bind-Expanded="@open" HideIcon="true">
            <TitleContent>
                <div class="d-flex">
                    <MudAlert Severity="Severity.Warning" Variant="Variant.Outlined">
                        @GetTranslation("AddNewCard")
                    </MudAlert>
                    <MudCard Elevation="1" Class="m-2 p-2">
                        <MudIcon Color="@AppColors.BASE_COLOR_ENUM" @onclick="OnAddCard" Icon="@(open ? Icons.Material.Filled.Close : Icons.Material.Filled.Add)" class="ml-auto"></MudIcon>
                    </MudCard>
                </div>
            </TitleContent>
            <ChildContent>
                <FormCard IsUpdate="isUpdate" BuildData="selectedCard" OnClickSave="OnSaveCard" />
            </ChildContent>
        </MudExpansionPanel>
    }
    else
    {
        <MudExpansionPanels >
            <MudExpansionPanel  @bind-Expanded="@open" HideIcon="true">
                <TitleContent>
                    <MudCardHeader Class="p-0 d-flex flex-row justify-content-center align-items-center ">
                        <MudText Typo="Typo.h4" Align="Align.Center" GutterBottom="true">@GetTranslation("CreditCards")</MudText>
                    </MudCardHeader>
                    <div class="d-flex flex-column">
                        <MudCard Elevation="1" Class="m-2 p-2">
                            <MudIcon Color="@AppColors.BASE_COLOR_ENUM" @onclick="OnAddCard" Icon="@(Icons.Material.Filled.Add)" class="ml-auto"></MudIcon>
                        </MudCard>
               @*           <MudRadioGroup  T="CardDetails" ValueChanged="OnSelectedCard"> *@
                            <div class="d-flex flex-wrap justify-content-start align-items-center w-100">
                                @* @foreach (var card in creditCards) *@
                                @* { *@
                                <TabelDashCard T="CardDetails" DataAndEventBuildTabel="dataAndEvent"
                                               StateCounts="cardStates"
                                               ActionTabels="groupAction"
                                           />
                                @* BarTabel = "TranslationsLST" *@
                                    @* <CreditCard BuildData="card" OnSetDefault="OnSelectedCard" OnDelete="OnDeleteCard" OnEdit="OnEditCard" /> *@
                                @* } *@
                            </div>
                        @* </MudRadioGroup> *@
                        @if (_isSelected)
                        {
                            <MudButton Class="w-100 my-3" Variant="Variant.Filled" Color="@AppColors.BASE_COLOR_ENUM" OnClick="@OnConfirmSelectedCard">
                                @GetTranslation("Confirm")
                            </MudButton>
                        }
                    </div>
                </TitleContent>
            </MudExpansionPanel>
        </MudExpansionPanels>
    }
</MudExpansionPanels>

@code
{

    private string lg = "ar";

    private DataAndEventBuildTabelCard<CardDetails> dataAndEvent;


    private List<CardDetails>? _dataBuild = new();





    [Parameter] public EventCallback<CardDetails> SelectedCard { get; set; }
    [Parameter] public EventCallback<CardDetails> CreateCard { get; set; }
    [Parameter] public EventCallback<CardDetails> EditCard { get; set; }
    [Parameter] public EventCallback<CardDetails> DeleteCard { get; set; }

    [Parameter] public List<CardDetails> BuildData { get => creditCards; set
        {
            if(value!=null)
                creditCards = value;
        } }


    private List<CardDetails> creditCards ;
    private CardDetails selectedCard = new CardDetails();
    private bool open, isUpdate = false;
    private bool _expanded = false;
    private bool _isSelected = false;
    List<CardStateCount<string>>? cardStates = null;
    GroupActionTabels groupAction = new GroupActionTabels();
    private static readonly Dictionary<string, Dictionary<string, string>> TranslationsLST = new()
        {
            ["en"] = new()
            {
                ["Text1"] = "Add  CreditCard",
                ["Text2"] = "",
                ["Description"] = "",
                ["ButtonLink"] = "Add CreditCard"
            },
            ["ar"] = new()
            {
                ["Text1"] = "إضافة بطاقة أئتمان ",
                ["Text2"] = "",
                ["Description"] = "",
                ["ButtonLink"] = "إضافة بطاقة أئتمان "
            }
        };

    private IDialogReference dialogRef;

    protected override async void OnInitialized()
    {
        ChangeLanguage(lg);

        if (creditCards == null)
        {
            creditCards = new List<CardDetails> { new CardDetails { CardNumber="454353455",HolderName="Azzaldeen",CardType="MasterCard",ExpirationDate="27/2",IsSelected=true } };
        }
        else if (SelectedCard.HasDelegate)      
        {
            if ((selectedCard == null || string.IsNullOrEmpty(selectedCard.CardNumber)) && creditCards?.Count() > 0)
                selectedCard = creditCards[0];

            if (selectedCard!=null)
                await SelectedCard.InvokeAsync(selectedCard);
        }

      

        initData(creditCards);
       
    }

    private void initData(List<CardDetails> dataBuild)
    {
        dataAndEvent = new()
            {
                DataBuild = dataBuild,
                LabelColumns = ColomsTrans[lg].ToList(),

                Events = new()
            };

        cardStates = new()
        {

            new()
            {
                Value="6",
                Label="Active"

            },

             new()
            {
                 Value="1",
                Label="UnActive"
            }
            ,


        };
        groupAction.Actions = new()
        {
            new()
            {
                Icon=@Icons.Material.Filled.AddCircle
                ,
                Tag="create"
                ,
                Name="انشاء",

            },
            new()
            {
                Icon=@Icons.Material.Filled.Delete
                ,
                IsMudChip=false,
                Tag="delete"
            }
        };
        groupAction.ChipClicked += OnChipClicked;

        // groupAction.CreateSpaceClicked = OnSubmitCreateSpace;
    }
    Dictionary<string, string[]> ColomsTrans = new Dictionary<string, string[]>
        {
            { "en", new string[] { "Card Number", "Holder Name","CardType", "ExpirationDate","Status" } },
            { "ar", new string[] {"رقم البطاقة", "حامل البطاقة", "نوع البطاقة", "تأريخ الانتهاء","الحالة"} }
        };
    private async Task OnChipClicked(CardActionTabel action)
    {
        if (action.Tag == "delete")
        {
            Snackbar.Add("fgffg", Severity.Error);

        }
        else if (action.Tag == "create")
        {
            await OnAddCard();

        }

        // await Task.CompletedTask;

    }
    private async Task OnAddCard()
    {
        isUpdate = false;
        // selectedCard = new CardDetails();
        StateHasChanged();

        await ShowCardDialog(GetTranslation("AddNewCard"), false, OnSaveCard, new CardDetails());
        // var parameters = new DialogParameters
        // {
        //     { "Title","Add new Card" },
        //     { "IsUpdate", false },
        //     { "OnClickSave", EventCallback.Factory.Create<CardDetails>(this, OnSaveCard) }
        // };
        // var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall, FullWidth = false };
        // dialogRef = DialogService.Show<FormCard>("", parameters, options);

 
    }
    private async Task OnDeleteCard(CardDetails card)
    {
        if (DeleteCard.HasDelegate && card != null)
            await DeleteCard.InvokeAsync(selectedCard);
    }
    private async Task OnEditCard(CardDetails card)
    {

        isUpdate = true;
        open = true;
        selectedCard = card;
        StateHasChanged();
        await ShowCardDialog(GetTranslation("EditCard"), true, OnSaveCard, card);
    }
    private async void OnSelectedCard(CardDetails card)
    {
        _isSelected = true;
        selectedCard = card;
        selectedCard.IsSelected = true;
        if (SelectedCard.HasDelegate && selectedCard != null)
            await SelectedCard.InvokeAsync(selectedCard);
        StateHasChanged();
    }
    private async void OnConfirmSelectedCard()
    {


        if (SelectedCard.HasDelegate && selectedCard!=null)
        {
            // foreach (var item in creditCards)
            // {
            //     if (!item.IsSelected)
            //         item.IsSelected = false;
            // }
            selectedCard.IsSelected = true;
            await SelectedCard.InvokeAsync(selectedCard);
        }
    }
    private async void OnSaveCard(CardDetails data)
    {
        if (data != null)
        { 
            //On Selected Card
        //     selectedCard = data;
        //     _isSelected = true;
        //     if (SelectedCard.HasDelegate)
        //         await SelectedCard.InvokeAsync(selectedCard);
        // }
        // else
        // {
            if (dialogRef != null)
                dialogRef.Close();

            if (isUpdate)
            {
                if (EditCard.HasDelegate)
                {
                    await EditCard.InvokeAsync(data);
                }

            }
            else
            {

                creditCards.Add(data);
                _isSelected = true;
                if (CreateCard.HasDelegate)
                {
                    await CreateCard.InvokeAsync(data);
                }
            }
        }

       

        StateHasChanged();
    }

 
    private async Task ShowCardDialog(string title, bool isUpdate, Action<CardDetails> callBack, CardDetails? data)
    {
        var parameters = new DialogParameters
        {
            { "Title",title },
            { "BuildData", data! },
            { "IsUpdate", isUpdate },
            { "OnClickSave", EventCallback.Factory.Create<CardDetails>(this, callBack) }
        };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall, FullWidth = false };
        dialogRef = DialogService.Show<FormCard>("", parameters, options);

        var result = await dialogRef.Result;

        //  if (result?.Canceled==false)
        // {

        // }

    }
    private string GetTranslation(string key)
    {
        if (lg == "ar")
        {
            return TransAr.ContainsKey(key) ? TransAr[key] : key;
        }
        else
        {
            return TransEn.ContainsKey(key) ? TransEn[key] : key;
        }
    }


    protected override async void OnAfterRender(bool firstRender)
    {
      // "en" أو "ar"

        if (firstRender)
        {
            lg = await _manageLanguageService.GetLanguageAsync();
            initData(creditCards);
            InvokeAsync(StateHasChanged);
        }


    }
    private void ChangeLanguage(string language)
    {
        // ااخ
        lg = language;
        StateHasChanged();
    }

    public static Dictionary<string, string> TransEn = new Dictionary<string, string>()
    {
        { "CreditCards", "Credit Cards" },
        { "AddNewCard", "Add New Card" },
        { "EditCard", "Edit Credit Card" },
        { "Expiry", "Expiry" },
        { "CardType", "Card Type" },
        { "Confirm", "Confirm" },
        { "Cancel", "Cancel" },
        { "Update", "Update" },
        { "Save", "Save" },
    };

    public static Dictionary<string, string> TransAr = new Dictionary<string, string>()
    {
        { "CreditCards", "بطاقات الائتمان" },
        { "AddNewCard", "إضافة بطاقة جديدة" },
        { "EditCard", "تعديل بطاقة الائتمان" },
        { "Expiry", "تاريخ الانتهاء" },
        { "CardType", "نوع البطاقة" },
        { "Confirm", "تأكيد" },
        { "Cancel", "إلغاء" },
        { "Update", "تحديث" },
        { "Save", "حفظ" },
    };
 

}